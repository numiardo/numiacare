<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NumiaCare – Innova tu cuidado</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/N.png" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
 <style>

           @import url('https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@300;400;500;600;700;800&display=swap');

.JB {
 position: fixed;
bottom: 24px;
right: 24px;
z-index: 9999;

      }


    body {
      font-family: 'Hanken Grotesk', system-ui, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
    }
    
    /* Reduce font size for the tagline text */
    .lead.mb-0 {
      font-size: 0.9rem;
      font-weight: 400;
      color: #666;
    }
    .boton-fecha {
      background-color: #863DFF;
      color: white;
      font-weight: 500;
      padding: 0.5rem 0.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s ease;
      margin-top: 20px;
    }
    .boton-fecha:hover {
      background-color: #863DFF;
    }
    .input-field {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #d1d5db;
      border-radius: 0.5rem;
      background-color: #ffffff;
      color: #333;
      transition: all 0.2s ease;
    }
    .input-field:focus {
      border-color: #863DFF;
      box-shadow: 0 0 0 2px rgba(237, 122, 26, 0.2);
      outline: none;
    }
    h2, .titulo {
      text-align: center;
      color: #863DFF;
      margin-top: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #formularioInicial, #resultados, #formularioDatos, #bloqueFecha {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 0.75rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    #formularioInicial {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    /* Estilos para el selector moderno de sucursales */
    .sucursal-selector {
      margin-bottom: 20px;
      display: none; /* Oculto inicialmente hasta que se seleccione una especialidad */
    }
    
    .selector-label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    
    .sucursal-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .sucursal-card {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sucursal-card:hover {
      border-color: #863DFF;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(134, 61, 255, 0.15);
    }
    
    .sucursal-card.selected {
      border-color: #863DFF;
      background: linear-gradient(135deg, #863DFF, #9f5fff);
      color: white;
      box-shadow: 0 8px 25px rgba(134, 61, 255, 0.3);
    }
    
    .sucursal-card.selected:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(134, 61, 255, 0.4);
    }
    
    .sucursal-icon {
      font-size: 1.5rem;
      color: #863DFF;
      flex-shrink: 0;
    }
    
    .sucursal-card.selected .sucursal-icon {
      color: white;
    }
    
    .sucursal-info {
      flex: 1;
    }
    
    .sucursal-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .sucursal-card.selected .sucursal-name {
      color: white;
    }
    
    .sucursal-status {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .sucursal-card.selected .sucursal-status {
      color: rgba(255, 255, 255, 0.9);
    }
    
    .loading-card {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      color: #6b7280;
      font-style: italic;
    }
    
    .spin {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .error-card {
      background: #fef2f2;
      border: 2px solid #fecaca;
      color: #dc2626;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    
    .sucursal-cards:empty::after {
      content: "No hay sucursales disponibles";
      display: block;
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }
    
    /* Estilos para el selector de salas */
    .sala-selector {
      margin-bottom: 20px;
    }
    
    .sala-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .sala-card {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sala-card:hover {
      border-color: #863DFF;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(134, 61, 255, 0.15);
    }
    
    .sala-card.selected {
      border-color: #863DFF;
      background: linear-gradient(135deg, #863DFF, #9f5fff);
      color: white;
      box-shadow: 0 8px 25px rgba(134, 61, 255, 0.3);
    }
    
    .sala-card.selected:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(134, 61, 255, 0.4);
    }
    
    .sala-icon {
      font-size: 1.5rem;
      color: #863DFF;
      flex-shrink: 0;
    }
    
    .sala-card.selected .sala-icon {
      color: white;
    }
    
    .sala-info {
      flex: 1;
    }
    
    .sala-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .sala-card.selected .sala-name {
      color: white;
    }
    
    .sala-status {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .sala-card.selected .sala-status {
      color: rgba(255, 255, 255, 0.9);
    }
    
    .sala-cards:empty::after {
      content: "No hay salas disponibles";
      display: block;
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }
    
    /* Estilos para el selector de especialidades */
    .selectors-container {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .especialidad-selector,
    .sucursal-selector,
    .sala-selector {
      flex: 1;
      min-width: 250px;
      margin-bottom: 0;
    }

    /* Estilos para la sección "Nuestro Sello" */
    .nuestro-sello-container {
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border: 2px solid #e8eaff;
      border-radius: 20px;
      padding: 3rem 2rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(134, 61, 255, 0.1);
    }

    .nuestro-sello-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #863DFF, #9f5fff, #863DFF);
    }

    .nuestro-sello-icon {
      margin-bottom: 1.5rem;
    }

    .nuestro-sello-icon i {
      font-size: 3rem;
      color: #863DFF;
      background: linear-gradient(135deg, #863DFF, #9f5fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nuestro-sello-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 1.5rem;
      line-height: 1.3;
    }

    .text-highlight {
      background: linear-gradient(135deg, #863DFF, #9f5fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }

    .nuestro-sello-description {
      font-size: 1.1rem;
      color: #666;
      line-height: 1.6;
      margin-bottom: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .nuestro-sello-features {
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: white;
      border: 2px solid #e8eaff;
      border-radius: 25px;
      color: #863DFF;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .feature-item:hover {
      border-color: #863DFF;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(134, 61, 255, 0.2);
    }

    .feature-item i {
      font-size: 1.2rem;
    }

    /* Responsive para la sección nuestro sello */
    @media (max-width: 768px) {
      .nuestro-sello-container {
        padding: 2rem 1.5rem;
        margin: 0 1rem;
      }

      .nuestro-sello-title {
        font-size: 1.8rem;
      }

      .nuestro-sello-description {
        font-size: 1rem;
      }

      .nuestro-sello-features {
        gap: 1rem;
      }

      .feature-item {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
    
    .especialidad-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .especialidad-card {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .especialidad-card:hover {
      border-color: #863DFF;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(134, 61, 255, 0.15);
    }
    
    .especialidad-card.selected {
      border-color: #863DFF;
      background: linear-gradient(135deg, #863DFF, #9f5fff);
      color: white;
      box-shadow: 0 8px 25px rgba(134, 61, 255, 0.3);
    }
    
    .especialidad-card.selected:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(134, 61, 255, 0.4);
    }
    
    .especialidad-icon {
      font-size: 1.5rem;
      color: #863DFF;
      flex-shrink: 0;
    }
    
    .especialidad-card.selected .especialidad-icon {
      color: white;
    }
    
    .especialidad-info {
      flex: 1;
    }
    
    .especialidad-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .especialidad-card.selected .especialidad-name {
      color: white;
    }
    
    .especialidad-status {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .especialidad-card.selected .especialidad-status {
      color: rgba(255, 255, 255, 0.9);
    }
    #formularioTurno {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    /* Popup */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 2% auto;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* Responsive adjustments for modal */
    @media (max-height: 600px) {
      .modal-content {
        margin: 1% auto;
        padding: 15px;
        max-height: 95vh;
      }
      
      /* Compact card styling for small screens */
      .sucursal-card, .sala-card, .especialidad-card {
        padding: 12px;
        gap: 8px;
      }
      
      .sucursal-cards, .sala-cards, .especialidad-cards {
        max-height: 200px;
        gap: 8px;
      }
      
      .selector-label {
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      
      .sucursal-selector, .sala-selector, .especialidad-selector {
        margin-bottom: 15px;
      }
    }
    
    @media (max-width: 768px) {
      .modal-content {
        width: 98%;
        margin: 1% auto;
        padding: 15px;
      }
      
      /* Compact card styling for mobile */
      .sucursal-card, .sala-card, .especialidad-card {
        padding: 12px;
        gap: 8px;
      }
      
      .sucursal-cards, .sala-cards, .especialidad-cards {
        max-height: 200px;
        gap: 8px;
      }
      
      .selector-label {
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      
      .sucursal-selector, .sala-selector, .especialidad-selector {
        margin-bottom: 15px;
      }
    }
        body {
            font-family: 'Hanken Grotesk', system-ui, sans-serif;
        }
        
                 .btn-primary {
             @apply bg-primary-500 hover:bg-primary-600 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200;
         }
         
         .btn-secondary {
             @apply bg-white hover:bg-gray-50 text-primary-500 border border-primary-500 font-medium py-3 px-6 rounded-lg transition-colors duration-200;
         }
        
        .card {
            @apply bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-200;
        }
        
                 .input-field {
             @apply w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200;
         }
         
         /* Estilos específicos para el popup */
         #formModal .input-field {
             @apply w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200;
         }
         
         /* Botones con fondo naranja */
         .btn-primary {
             @apply bg-primary-500 hover:bg-primary-600 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200;
         }
         
         /* Asegurar que los campos del popup tengan bordes visibles */
         #formModal input[type="text"],
         #formModal input[type="email"],
         #formModal input[type="tel"] {
             border: 2px solid #d1d5db !important;
             border-radius: 0.5rem !important;
             padding: 0.75rem 1rem !important;
             width: 100% !important;
             transition: all 0.2s ease !important;
         }
         
         #formModal input[type="text"]:focus,
         #formModal input[type="email"]:focus,
         #formModal input[type="tel"]:focus {
             border-color: #863DFF !important;
             box-shadow: 0 0 0 2px rgba(237, 122, 26, 0.2) !important;
             outline: none !important;
         }
         
         /* Asegurar que los botones del popup tengan el color naranja correcto */
         #formModal .btn-primary {
             background-color: #863DFF !important;
             color: white !important;
             font-weight: 500 !important;
             padding: 0.75rem 1.5rem !important;
             border-radius: 0.5rem !important;
             transition: background-color 0.2s ease !important;
         }
         
         #formModal .btn-primary:hover {
             background-color: #863DFF !important;
         }
         
         /* Estilos para la información del turno */
         .turn-info-display {
             background: linear-gradient(135deg, #3B82F6, #1D4ED8);
             border-radius: 0.75rem;
             box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
             border: 1px solid rgba(255, 255, 255, 0.1);
         }
         
         .turn-info-display h4 {
             color: #ffffff;
             font-weight: 600;
             margin-bottom: 1rem;
         }
         
         .turn-info-display .info-row {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.5rem 0;
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
         }
         
         .turn-info-display .info-row:last-child {
             border-bottom: none;
         }
         
         .turn-info-display .info-label {
             color: rgba(255, 255, 255, 0.9);
             font-weight: 500;
         }
         
                  .turn-info-display .info-value {
             color: #ffffff;
             font-weight: 700;
             font-size: 1.1rem;
         }
         
         /* Estilos para la información del turno dentro del modal */
         .turn-info-container {
             padding: 20px;
         }
         
         .turn-info-grid {
             display: grid;
             gap: 20px;
             margin: 20px 0;
         }
         
         .turn-info-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 15px;
             background: linear-gradient(135deg, #f8f9ff, #e6ecf9);
             border-radius: 10px;
             border: 1px solid #e0e7ff;
         }
         
         .turn-info-label {
             font-weight: 600;
             color: #374151;
             font-size: 0.95rem;
         }
         
         .turn-info-value {
             font-weight: 700;
             color: #863DFF;
             font-size: 1.1rem;
             text-align: right;
         }
         
         @media (max-width: 768px) {
             .turn-info-item {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: 8px;
             }
             
             .turn-info-value {
                 text-align: left;
                 width: 100%;
             }
         }
         
         /* Estilos para el contenedor de errores */
         .error-container {
             text-align: center;
             padding: 20px;
         }
         
         .error-icon {
             margin-bottom: 20px;
         }
         
         .error-message {
             color: #6c757d;
             font-size: 1rem;
             line-height: 1.5;
         }
    
    /* --- Variables de color --- */
    :root {
      --numia-azul: #863DFF;
      --numia-azul-claro: #e6ecf9; /* para fondos suaves */
      --numia-azul-muy-claro: #eef2fc; /* para segunda franja */
    }

    body {
      font-family: 'Hanken Grotesk', system-ui, sans-serif;
      background: #f7f7f7;
    }
    .card.ad-card {
      border-radius: 1.2rem;
      box-shadow: 0 4px 18px rgba(0,0,0,0.08);
      transition: transform 0.18s, box-shadow 0.18s;
      min-width: 210px;
      min-height: 380px;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      height: 100%;
    }
    .card.ad-card:hover {
      transform: translateY(-4px) scale(1.025);
      /* sombra adaptada al azul */
      box-shadow: 0 8px 32px rgba(0,19,145,0.17);
    }
    .card-img-top-holder {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fff8f8;
      border-top-left-radius: 1.2rem;
      border-top-right-radius: 1.2rem;
    }
    .card-img-top-holder img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transition: transform 0.3s;
    }
    .ad-card .card-body {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100%;
      padding-bottom: 1.5rem;
    }
    .ad-card .card-title {
      font-weight: 700;
      color: var(--numia-azul);
      font-size: 1.25rem;
      margin-bottom: .25rem;
      margin-top: 1rem;
      min-height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .ad-card .card-text {
      font-size: 1.01rem;
      color: #2d2d2d;
      font-weight: 500;
      opacity: 0.88;
      margin-bottom: 1.1rem;
      min-height: 56px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel-item img {
      object-fit: cover;
      width: 100%;
      height: 340px;
      border-radius: 0.7rem;
    }
    @media (max-width: 991px) {
      .main-cards .col-lg-3 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 1rem;
      }
      .carousel-item img {
        height: 180px;
      }
    }
    @media (max-width: 767px) {
      .main-cards .col-lg-3 {
        flex: 0 0 100%;
        max-width: 100%;
      }
      .carousel-item img {
        height: 140px;
      }
      .card-img-top-holder {
        height: 140px;
      }
      .ad-card .card-title { font-size: 1.08rem; }
    }

    /* --- Sección de Divisas/Tasas --- */
    .rates-section {
      display: flex;
      gap: 2.2rem;
      align-items: stretch;
      margin: 36px 0 0 0;
      width: 100%;
      flex-wrap: wrap;
    }
    .rates-col-table {
      background: #fff;
      border-radius: 1.1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 2.1rem 1.6rem 1.6rem 1.7rem;
      min-width: 340px;
      flex: 2 1 540px;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .rates-col-side {
      background: #fff;
      border-radius: 1.1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 2.1rem 1.6rem 1.6rem 1.7rem;
      min-width: 220px;
      flex: 1 1 320px;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
    }
    .rates-col-side .bi {
      font-size: 2.6rem;
      color: var(--numia-azul);
      margin-bottom: .7rem;
    }
    .rates-col-side h5 {
      color: var(--numia-azul);
      font-weight: 700;
      margin-bottom: .5rem;
      font-size: 1.2rem;
    }
    .rates-col-side p {
      color: #444;
      font-size: 1.07rem;
      font-weight: 500;
      margin-bottom: 1.2rem;
      opacity: .93;
    }
    .rates-col-side .btn {
      /* usamos el azul numia como fondo */
      background: var(--numia-azul);
      border: none;
      color: #fff;
      font-weight: 700;
      border-radius: 24px;
      padding: 0.7rem 2.1rem;
      font-size: 1.07rem;
      box-shadow: 0 2px 7px rgba(0,19,145,0.06);
      transition: background 0.18s;
    }
    .rates-col-side .btn:hover {
      /* ligero oscurecimiento */
      background: #000d73;
      color: #fff;
    }

    /* --- Botones de pestañas Divisas/Tasas --- */
    .rates-tab-btn {
      padding: .7rem 0;
      border: none;
      border-radius: 9px;
      font-weight: bold;
      font-size: 1.1rem;
      background: #fff;
      color: var(--numia-azul);
      margin-bottom: 0;
      transition: background .16s, color .16s;
      cursor: pointer;
      box-shadow: none;
      outline: none;
      border: 2px solid #d1d9f9; /* borde muy claro */
      min-width: 70px;
    }
    .rates-tab-btn.active,
    .rates-tab-btn:focus {
      background: var(--numia-azul);
      color: #fff;
      border: 2px solid var(--numia-azul);
    }

    /* --- Tabla de tasas/divisas --- */
    .rates-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 0.8rem;
      overflow: hidden;
      margin-top: 0.7rem;
    }
    .rates-table th,
    .rates-table td {
      padding: 12px 18px;
      font-size: 1.04rem;
      text-align: left;
    }
    .rates-table th {
      color: var(--numia-azul);
      background: var(--numia-azul-claro);
      border: none;
      font-size: 1.08rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .rates-table tr:not(:last-child) {
      border-bottom: 1px solid #cde0f8;
    }
    .rates-table tr:nth-child(2) {
      background: var(--numia-azul-claro);
    }
    .rates-table tr:nth-child(3) {
      background: var(--numia-azul-muy-claro);
    }
    .rates-table td {
      color: #222;
      font-weight: 500;
      text-align: center;
      vertical-align: middle;
    }
    .rates-table td:first-child,
    .rates-table th:first-child {
      text-align: left;
    }

    @media (max-width: 1300px) {
      .rates-col-table {
        min-width: 0;
        flex-basis: 400px;
      }
      .rates-col-side {
        min-width: 0;
      }
    }
    @media (max-width: 991px) {
      .rates-section {
        flex-direction: column;
        gap: 1.4rem;
      }
      .rates-col-table,
      .rates-col-side {
        min-width: 0;
        max-width: 100%;
      }
      .rates-col-side {
        align-items: flex-start;
        padding-top: 1.2rem;
      }
    }

    /* --- Estilos específicos para botones y elementos que antes eran 'rojos' --- */
    /* Creamos una clase para forzar que btn-primary use nuestro azul */
    .btn-primary {
      background-color: var(--numia-azul) !important;
      border-color: var(--numia-azul) !important;
    }
    .btn-primary:hover {
      background-color: #000d73 !important;
      border-color: #000d73 !important;
    }
    .btn-outline-primary {
      color: var(--numia-azul) !important;
      border-color: var(--numia-azul) !important;
    }
    .btn-outline-primary:hover {
      background-color: var(--numia-azul) !important;
      color: #fff !important;
    }

    /* Cambiamos el icono de maximizar del chat para que destaque sobre azul */
    #max-chat {
      background: var(--numia-azul) !important;
    }
    #open-chat {
      background: var(--numia-azul) !important;
    }
  </style>

</head>
<body class="d-flex flex-column min-vh-100">

  <!-- HEADER -->
  <header class="bg-white shadow-sm">
    <div class="container d-flex align-items-center py-2">
      <a href="index.html">
       <img src="images/numia.png" alt="Numia Bank Logo" class="img-fluid" style="max-height: 88px;height:50px" />
      </a>
    </div>
    <div class="container">
      <p class="lead mb-0">Innovación en salud, cuidando de ti con la mejor tecnología</p>
    </div>
  </header>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
    <div class="container">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-center" id="navbarMain">
        <ul class="navbar-nav mb-2 mb-lg-0">
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle" href="#" id="pacientes" data-bs-toggle="dropdown">
              <i class="bi bi-person me-1"></i>Pacientes
            </a>
            <ul class="dropdown-menu" aria-labelledby="pacientes">
              <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Perfil</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-clock-history me-2"></i>Historial</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-credit-card-2-front me-2"></i>Pagos</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle" href="#" id="citas" data-bs-toggle="dropdown">
              <i class="bi bi-calendar-check me-1"></i>Citas
            </a>
            <ul class="dropdown-menu" aria-labelledby="citas">
              <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-plus me-2" onclick="cargarCombosDesdeAPI()"></i>Agendar cita</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-calendar2-check me-2"></i>Mis citas</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle" href="#" id="especialidades" data-bs-toggle="dropdown">
              <i class="bi bi-bar-chart-line me-1"></i>Especialidades
            </a>
            <ul class="dropdown-menu" aria-labelledby="especialidades">
              <li><a class="dropdown-item" href="#"><i class="bi bi-heart-pulse me-2"></i>Cardiología</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-bandaid me-2"></i>Pediatría</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-person-badge me-2"></i>Ortopedia</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle" href="#" id="seguros" data-bs-toggle="dropdown">
              <i class="bi bi-shield-check me-1"></i>Seguros
            </a>
            <ul class="dropdown-menu" aria-labelledby="seguros">
              <li><a class="dropdown-item" href="#"><i class="bi bi-hospital me-2"></i>Médico</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-tooth me-2"></i>Dental</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-heart-fill me-2"></i>Vida</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CARRUSEL -->
  <div class="container my-4">
    <div id="carouselMain" class="carousel slide shadow-sm" data-bs-ride="carousel">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="images/Carrusel_salud1.png" alt="Promo Salud 1">
          <div class="carousel-caption d-none d-md-block">
            <h5>Atención 24/7</h5>
            <p>Telemedicina al alcance de un clic</p>
            <a href="#" class="btn btn-primary rounded-pill px-4 mt-2">Descúbrelo</a>
          </div>
        </div>
        <div class="carousel-item">
          <img src="images/Carrusel_salud2.png" alt="Promo Salud 2">
          <div class="carousel-caption d-none d-md-block">
            <h5>Chequeos preventivos</h5>
            <p>Paquetes completos a precio especial</p>
            <a href="#" class="btn btn-outline-primary rounded-pill px-4 mt-2">Más info</a>
          </div>
        </div>
        <div class="carousel-item">
          <img src="images/Carrusel_salud3.png" alt="Promo Salud 3">
          <div class="carousel-caption d-none d-md-block">
            <h5>Laboratorio en línea</h5>
            <p>Resultados rápidos y seguros</p>
            <a href="#" class="btn btn-primary rounded-pill px-4 mt-2">Solicitar</a>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselMain" data-bs-slide="prev">
        <span class="carousel-control-prev-icon bg-dark rounded-circle"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselMain" data-bs-slide="next">
        <span class="carousel-control-next-icon bg-dark rounded-circle"></span>
      </button>
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#carouselMain" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#carouselMain" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#carouselMain" data-bs-slide-to="2"></button>
      </div>
    </div>
  </div>

  
  <!-- TARJETAS DE SERVICIOS -->
  <main class="container mb-5">
    <div class="row g-4 justify-content-center main-cards">
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card text-center">
          <div class="card-img-top-holder">
            <img src="images/agendar_cita.png" alt="Agendar Cita">
          </div>
          <div class="card-body">
            <h5 class="card-title">Agendar cita médica</h5>
            <p class="card-text">Elige fecha, hora y doctor en línea.</p>
            <button class="btn btn-primary rounded-pill px-4 mt-2" onclick="cargarCombosDesdeAPI()">Agendar</button>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card text-center">
          <div class="card-img-top-holder">
            <img src="images/telemedicina.png" alt="Telemedicina">
          </div>
          <div class="card-body">
            <h5 class="card-title">Telemedicina</h5>
            <p class="card-text">Consulta virtual desde tu dispositivo.</p>
            <button class="btn btn-outline-primary rounded-pill px-4 mt-2" onclick="openViajeroPopup()">Conecta</button>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card text-center">
          <div class="card-img-top-holder">
            <img src="images/triage.png" alt="Triage">
          </div>
          <div class="card-body">
            <h5 class="card-title">Estoy en la guardia</h5>
            <p class="card-text">Evaluación inicial para priorizar atención.</p>
            <button class="btn btn-primary rounded-pill px-4 mt-2" onclick="showFormModal()">Iniciar</button>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card text-center">
          <div class="card-img-top-holder">
            <img src="images/laboratorio.png" alt="Laboratorio">
          </div>
          <div class="card-body">
            <h5 class="card-title">Laboratorio</h5>
            <p class="card-text">Agrega análisis con resultados rápidos.</p>
            <button class="btn btn-outline-primary rounded-pill px-4 mt-2">Programar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCIÓN NUESTRO SELLO -->
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <div class="nuestro-sello-container">
          <div class="nuestro-sello-icon">
            <i class="bi bi-star-fill"></i>
          </div>
          <h2 class="nuestro-sello-title">En nuestras Clínicas nuestro sello es ser <span class="text-highlight">Memorables</span></h2>
          <p class="nuestro-sello-description">
            Cada paciente es único y merece una atención excepcional. Nos comprometemos a brindar experiencias 
            de salud que trasciendan lo ordinario, creando momentos memorables en cada interacción.
          </p>
          <div class="nuestro-sello-features">
            <div class="feature-item">
              <i class="bi bi-heart-pulse"></i>
              <span>Atención Personalizada</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-shield-check"></i>
              <span>Calidad Garantizada</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-people"></i>
              <span>Equipo Comprometido</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  </main>



  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function showRatesTab(tab) {
      const eBtn = document.getElementById('tabEspecial'),
            cBtn = document.getElementById('tabConsulta'),
            eTab = document.getElementById('tablaEspecial'),
            cTab = document.getElementById('tablaConsulta');
      if(tab==='especial'){
        eBtn.classList.add('active');
        cBtn.classList.remove('active');
        eTab.style.display=''; cTab.style.display='none';
      } else {
        eBtn.classList.remove('active');
        cBtn.classList.add('active');
        eTab.style.display='none'; cTab.style.display='';
      }
    }
    window.showRatesTab = showRatesTab;

    document.addEventListener('DOMContentLoaded', () => {
      const iframe = document.getElementById('numia-chat-bubble'),
            btn    = document.getElementById('max-chat'),
            openBtn= document.getElementById('open-chat');
      let maxed = false;
      openBtn.onclick = () => {
        iframe.style.display = 'block';
        btn.style.display = 'flex';
        openBtn.style.display = 'none';
      };
      btn.onclick = () => {
        if (!maxed) {
          iframe.style.width = '98vw';
          iframe.style.height = '94vh';
          iframe.style.bottom = '3vh';
          iframe.style.right = '1vw';
          btn.textContent = '🗗';
        } else {
          iframe.style.width = '370px';
          iframe.style.height = '550px';
          iframe.style.bottom = '24px';
          iframe.style.right = '24px';
          btn.textContent = '⛶';
        }
        maxed = !maxed;
      };
    });
  </script>

  <!-- Chat -->
  <iframe
    id="numia-chat-bubble"
    src="https://filavirtual.preprod.debmedia.com/Numiabot/#/QSUhg5KzUl0xpYKvglOS"
    allow="camera; microphone"
    style="position:fixed;bottom:24px;right:24px;width:370px;height:550px;border:none;z-index:9999;border-radius:18px;overflow:hidden;display:none;"
  ></iframe>
  <button id="open-chat"
    style="position:fixed;bottom:24px;right:24px;width:64px;height:64px;border:none;border-radius:50%;background:var(--numia-purpura);color:#fff;font-size:2.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10001;"
  >N</button>
  <button id="max-chat"
    style="position:fixed;bottom:590px;right:24px;width:48px;height:48px;border:none;border-radius:50%;background:var(--numia-purpura);color:#fff;font-size:1.6rem;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:10000;"
  >⛶</button>

  

<div id="popupModal" class="modal">
 
    <div class="modal-content">
    <span class="close" onclick="document.getElementById('popupModal').style.display='none'">&times;</span>
    <div>
         <h3 class='titulo'>Seleccione una agenda</h3>
    </div>
    <div id="formularioInicial">



      <div class="selectors-container">
        <div class="especialidad-selector">
          <label class="selector-label">Selecciona una especialidad:</label>
          <div id="especialidadCombo" class="especialidad-cards">
            <div class="especialidad-card" data-value="cardiologia">
              <i class="bi bi-heart-pulse especialidad-icon"></i>
              <div class="especialidad-info">
                <div class="especialidad-name">Cardiología</div>
                <div class="especialidad-status">Disponible</div>
              </div>
            </div>
            <div class="especialidad-card" data-value="medico-clinico">
              <i class="bi bi-person-vcard especialidad-icon"></i>
              <div class="especialidad-info">
                <div class="especialidad-name">Médico Clínico</div>
                <div class="especialidad-status">Disponible</div>
              </div>
            </div>
            <div class="especialidad-card" data-value="alergias">
              <i class="bi bi-droplet especialidad-icon"></i>
              <div class="especialidad-info">
                <div class="especialidad-name">Alergias</div>
                <div class="especialidad-status">Disponible</div>
              </div>
            </div>
            <div class="especialidad-card" data-value="dermatologia">
              <i class="bi bi-bandaid especialidad-icon"></i>
              <div class="especialidad-info">
                <div class="especialidad-name">Dermatología</div>
                <div class="especialidad-status">Disponible</div>
              </div>
            </div>
          </div>
          <input type="hidden" id="especialidadComboValue" required>
        </div>
        
        <div class="sucursal-selector">
          <label class="selector-label">Selecciona una sucursal:</label>
          <div id="sucuCombo" class="sucursal-cards">
            <div class="loading-card">
              <i class="bi bi-arrow-clockwise spin"></i>
              <span>Cargando sucursales...</span>
            </div>
          </div>
          <input type="hidden" id="sucuComboValue" required>
        </div>
        
        <div class="sala-selector">
          <label class="selector-label">Selecciona una agenda:</label>
          <div id="salaCombo" class="sala-cards">
            <div class="loading-card">
              <i class="bi bi-arrow-clockwise spin"></i>
              <span>Selecciona especialidad y sucursal para ver las agendas disponibles</span>
            </div>
          </div>
          <input type="hidden" id="salaComboValue" required>
        </div>
      </div>
</div>

        <!--div align="center">
        <button type="button" class="boton-fecha" onclick="cargarCombosDesdeAPI()">Buscar</button>
      </div-->
      <div id="bloqueFecha" style="display: none;">
        <label for="fecha">Seleccione una fecha: </label>
        <input type="text" id="fecha" placeholder="Elige una fecha" />
      </div>
    
    <div id="resultados" class="flex flex-wrap gap-3 justify-center my-4"></div>
    <div id="formularioDatos" style="display: none;"></div>
    <div id="final"></div>
  </div>
</div>
</div>
  
    <!-- Modal Form -->
   <!-- Modal Form (estilo popup unificado) -->
<div id="formModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="hideForm()">&times;</span>
    <h3 class="titulo">Reserva tu Turno</h3>
    <div id="message" class="hidden p-4 rounded-lg mb-4"></div>

    <form id="reservaForm" class="space-y-4" onsubmit="return handleSubmit(event)">
      <label>Nombre</label>
      <input type="text" name="firstName" required class="input-field" />

      <label>Apellido</label>
      <input type="text" name="lastName" required class="input-field" />

      <label>DNI</label>
      <input type="text" name="dni" required class="input-field" />

      <label>Email</label>
      <input type="email" name="email" required class="input-field" />

      <label>Teléfono</label>
      <input type="tel" name="phone" required class="input-field" />

      <div class="d-flex justify-content-between pt-3">
        <button type="button" class="boton-fecha" id="submitBtn" onclick="reservarTurnoReal()">Reservar Turno</button>
        <button type="button" class="boton-fecha" onclick="hideForm()">Cancelar</button>
      </div>
    </form>
  </div>
</div>
 <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  

  <!-- Pie de página con mt-auto para pegarlo al fondo -->
  <footer class="bg-light text-center py-3 mt-auto border-top">
    <small>&copy; NumiaBank. Todos los derechos reservados.</small>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 
    JavaScript para:
    1) Conmutar pestañas de Divisas / Tasas
    2) Controlar la apertura/maximización del chat
  -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Función de pestañas (Divisas / Tasas)
      function showRatesTab(tab) {
        const tabDivisas = document.getElementById('tabDivisas');
        const tabTasas = document.getElementById('tabTasas');
        const tablaDivisas = document.getElementById('tablaDivisas');
        const tablaTasas = document.getElementById('tablaTasas');
        if (tab === 'divisas') {
          tabDivisas.classList.add('active');
          tabTasas.classList.remove('active');
          tablaDivisas.style.display = '';
          tablaTasas.style.display = 'none';
        } else {
          tabDivisas.classList.remove('active');
          tabTasas.classList.add('active');
          tablaDivisas.style.display = 'none';
          tablaTasas.style.display = '';
        }
      }
      // Exponer la función globalmente para el onclick en HTML
      window.showRatesTab = showRatesTab;

      // Control de la burbuja de chat
      const iframe = document.getElementById('numia-chat-bubble');
      const btn = document.getElementById('max-chat');
      const openBtn = document.getElementById('open-chat');
      let maximized = false;

      // Al hacer clic en la burbuja, mostrar el iframe y el botón de maximizar
      openBtn.onclick = function() {
        iframe.style.display = 'block';
        btn.style.display = 'flex';
        openBtn.style.display = 'none';
      };
      // Al hacer clic en el botón de maximizar/minimizar
      btn.onclick = function() {
        if (!maximized) {
          iframe.style.width = '98vw';
          iframe.style.height = '94vh';
          iframe.style.bottom = '3vh';
          iframe.style.right = '1vw';
          iframe.style.boxShadow = 'none';
          btn.style.bottom = 'calc(94vh + 3vh + 12px)';
          btn.textContent = '🗗';
          maximized = true;
        } else {
          iframe.style.width = '370px';
          iframe.style.height = '550px';
          iframe.style.bottom = '24px';
          iframe.style.right = '24px';
          iframe.style.boxShadow = 'none';
          btn.style.bottom = '590px';
          btn.textContent = '⛶';
          maximized = false;
        }
      };
    });
  </script>

  <!-- CHAT -->
  <iframe
    src="https://filavirtual.preprod.debmedia.com/Numiabot/#/Ff5h9OOAsmhNELUjk1Dh"
    id="numia-chat-bubble"
    style="
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 370px;
      height: 550px;
      border: none;
      z-index: 9999;
      border-radius: 18px;
      overflow: hidden;
      transition: width 0.3s, height 0.3s, right 0.3s, bottom 0.3s;
      display: none;
    "
    allow="camera; microphone"
  ></iframe>
</body>


<script>

        // Aquí va el JS de reservas, igual al que ya tienes, recortado para simplicidad
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
});
        // Inicializar iconos de Lucide
        lucide.createIcons();

        // Variables globales
        let isLoading = false;

        // Funciones para mostrar/ocultar el formulario
    function showForm() {
      document.getElementById('formModal').style.display = 'block';
      document.getElementById('message').classList.add('hidden');
      document.getElementById('reservaForm').reset();
      
      // Restaurar la visibilidad del formulario
      const form = document.getElementById('reservaForm');
      if (form) {
          form.style.display = 'block';
      }
    }
    window.showForm = showForm;
    
    // Alias para showFormModal (usado en el botón "Estoy en la guardia")
    function showFormModal() {
      showForm();
    }
    window.showFormModal = showFormModal;

function hideForm() {
  console.log('hideForm llamado desde:', new Error().stack);
  document.getElementById('formModal').style.display = 'none';
}
window.hideForm = hideForm;

        // Función para mostrar mensajes
        function showMessage(text, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `p-4 rounded-lg mb-4 ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageDiv.classList.remove('hidden');
        }

        // Función para manejar el envío del formulario
        async function handleSubmit(event) {
            console.log('🚀 handleSubmit EJECUTÁNDOSE - previniendo submit del formulario');
            event.preventDefault();
            
            console.log('=== INICIO DE RESERVA DE TURNO ===');
            
            if (isLoading) return;
            
            isLoading = true;
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Reservando...';
            submitBtn.disabled = true;

            const formData = new FormData(event.target);
            const data = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                dni: formData.get('dni'),
                email: formData.get('email'),
                phone: formData.get('phone')
            };

            console.log('Datos del formulario:', data);

            try {
                console.log('Enviando solicitud al API...');
                const response = await fetch('https://filavirtual2.debmedia.com/api/v1/queue/14003/branch/10387/enqueue', {
                    method: 'POST',
                    headers: {
                        'x-api-token': 'bLb0B67zB43NwgaM2EaDrQk1PTPcbl5JB2UFV6S3',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('Respuesta del API:', response.status, response.ok);
                console.log('Headers de respuesta:', response.headers);
                console.log('URL de la respuesta:', response.url);

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Datos del API recibidos:', responseData);
                    
                    // Verificar la estructura de la respuesta
                    console.log('Estructura de la respuesta:', {
                        jsonDetails: responseData.jsonDetails,
                        hasJsonDetails: !!responseData.jsonDetails,
                        actualTurn: responseData.jsonDetails?.actualTurn,
                        averageWaitingTime: responseData.jsonDetails?.averageWaitingTime,
                        queueName: responseData.jsonDetails?.queue?.name,
                        waitingRoomName: responseData.jsonDetails?.waitingRoom?.name
                    });
                    
                    // Extraer información del turno con fallbacks mejorados
                    let turnInfo = {
                        turno: 'N/A',
                        tiempoEspera: 'N/A',
                        especialidad: 'N/A',
                        salaEspera: 'N/A',
                        codigo: responseData.code || 'N/A' // Agregar el código del turno
                    };
                    
                    // Intentar extraer datos de diferentes estructuras posibles
                    if (responseData.jsonDetails) {
                        turnInfo.turno = responseData.jsonDetails.actualTurn || responseData.jsonDetails.turn || 'N/A';
                        turnInfo.tiempoEspera = responseData.jsonDetails.averageWaitingTime || responseData.jsonDetails.serviceTime || 'N/A';
                        turnInfo.especialidad = responseData.jsonDetails.queue?.name || 'N/A';
                        turnInfo.salaEspera = responseData.jsonDetails.waitingRoom?.name || 'N/A';
                    } else if (responseData.code) {
                        // Si no hay jsonDetails, usar datos del nivel principal
                        turnInfo.turno = responseData.code || 'N/A';
                        turnInfo.tiempoEspera = responseData.jsonDetails?.serviceTime || 'N/A';
                        turnInfo.especialidad = 'Atención General';
                        turnInfo.salaEspera = 'Sala Principal';
                    }
                    
                    console.log('Información del turno extraída:', turnInfo);
                    
                    // Guardar el código del turno en localStorage
                    if (responseData.code) {
                        localStorage.setItem('turnCode', responseData.code);
                    }
                    
                    // IMPORTANTE: Mostrar información del turno ANTES de cualquier otra cosa
                    console.log('Llamando a showTurnInfoInModal con:', turnInfo);
                    showTurnInfoInModal(turnInfo);
                    
                    console.log('Información del turno mostrada en el modal');
                    
                    // Verificación adicional de que el turno se generó
                    if (turnInfo.turno !== 'N/A') {
                        console.log('✅ TURNO GENERADO EXITOSAMENTE:', turnInfo.turno);
                    } else {
                        console.log('⚠️ ADVERTENCIA: No se pudo extraer el número de turno');
                    }
                    
                } else {
                    throw new Error('Error en la respuesta del servidor: ' + response.status);
                }
            } catch (error) {
                console.error('Error durante la reserva:', error);
                showErrorInModal('Error al reservar el turno: ' + error.message);
            } finally {
                isLoading = false;
                submitBtn.textContent = 'Reservar Turno';
                submitBtn.disabled = false;
                console.log('=== FIN DE RESERVA DE TURNO ===');
            }
            
            // IMPORTANTE: Prevenir que el formulario se envíe
            return false;
        }
        
        // Hacer la función handleSubmit disponible globalmente
        window.handleSubmit = handleSubmit;

        // Función para el botón "Estoy aquí"
        async function handleEstoyAqui() {
            if (isLoading) return;
            
            isLoading = true;
            const btn = document.getElementById('estoyAquiBtn');
            btn.textContent = 'Enviando...';
            btn.disabled = true;

            try {
                const response = await fetch('https://filavirtual2.debmedia.com/api/v1/queue/15055/branch/10588/enqueue', {
                    method: 'POST',
                    headers: {
                        'x-api-token': 'bLb0B67zB43NwgaM2EaDrQk1PTPcbl5JB2UFV6S3',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName: "Jorge",
                        lastName: "Macera",
                        dni: "29328703",
                        email: "jmacera@gmail.com",
                        phone: "1558668241"
                    })
                });

                if (response.ok) {
                    const responseData = await response.json();
                    
                    // Extraer información del turno
                    const turnInfo = {
                        turno: responseData.jsonDetails?.actualTurn || 'N/A',
                        tiempoEspera: responseData.jsonDetails?.averageWaitingTime || 'N/A',
                        especialidad: responseData.jsonDetails?.queue?.name || 'N/A',
                        salaEspera: responseData.jsonDetails?.waitingRoom?.name || 'N/A'
                    };
                    
                    // Mostrar información del turno en modal flotante
                    showTurnInfo(turnInfo);
                    
                    alert('¡Notificación enviada exitosamente!');
                } else {
                    throw new Error('Error en la respuesta del servidor');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar la notificación. Por favor, inténtalo de nuevo.');
            } finally {
                isLoading = false;
                btn.textContent = '¡Estoy aquí!';
                btn.disabled = false;
            }
        }

        // Función para el botón "Estoy acá" (nueva sección)
        async function handleEstoyAca() {
            if (isLoading) return;
            
            isLoading = true;
            const btn = document.getElementById('estoyAcaBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 mr-3 animate-spin"></i>Enviando...';
            btn.disabled = true;

            try {
                const response = await fetch('https://filavirtual2.debmedia.com/api/v1/queue/15090/branch/10588/enqueue', {
                    method: 'POST',
                    headers: {
                        'x-api-token': 'iyAUHKKJ2NTsxf4sAH1OWm3fljRsThvxF0kbCGWe',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                    firstName: "Jorge",
                        lastName: "Macera",
                        dni: "29328703",
                        email: "jmacera@gmail.com",
                        phone: "1558668241"
                    })
                });

                if (response.ok) {
                    const responseData = await response.json();
                    
                    // Extraer información del turno
                    const turnInfo = {
                        turno: responseData.jsonDetails?.actualTurn || 'N/A',
                        tiempoEspera: responseData.jsonDetails?.averageWaitingTime || 'N/A',
                        especialidad: responseData.jsonDetails?.queue?.name || 'N/A',
                        salaEspera: responseData.jsonDetails?.waitingRoom?.name || 'N/A'
                    };
                    
                    // Mostrar información del turno en modal flotante
                    showTurnInfo(turnInfo);
                    
                    // Mostrar mensaje de éxito con estilo
                    showSuccessMessage('¡Perfecto! Ya estás registrado en la cola. Te atenderemos pronto.');
                    btn.innerHTML = '<i data-lucide="check" class="w-6 h-6 mr-3"></i>¡Enviado!';
                    btn.classList.remove('bg-primary-500', 'hover:bg-primary-600');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                     
                    // Resetear después de 3 segundos
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btn.classList.add('bg-primary-500', 'hover:bg-primary-600');
                    }, 3000);
                } else {
                    throw new Error('Error en la respuesta del servidor');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorMessage('Error al enviar la notificación. Por favor, inténtalo de nuevo.');
            } finally {
                isLoading = false;
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // Función para mostrar mensaje de éxito
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="w-6 h-6 mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(messageDiv);
            lucide.createIcons();

            // Remover después de 5 segundos
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

                 // Función para mostrar mensaje de error
         function showErrorMessage(message) {
             const messageDiv = document.createElement('div');
             messageDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
             messageDiv.innerHTML = `
                 <div class="flex items-center">
                     <i data-lucide="alert-circle" class="w-6 h-6 mr-3"></i>
                     <span>${message}</span>
                 </div>
             `;
             document.body.appendChild(messageDiv);
             lucide.createIcons();

             // Remover después de 5 segundos
             setTimeout(() => {
                 messageDiv.remove();
             }, 5000);
         }

                  // Función para mostrar errores dentro del modal
         function showErrorInModal(errorMessage) {
             console.log('=== MOSTRANDO ERROR EN MODAL ===');
             console.log('Mensaje de error:', errorMessage);
             
             try {
                 const form = document.getElementById('reservaForm');
                 
                 if (!form) {
                     console.error('ERROR: No se encontró el formulario para mostrar error');
                     return;
                 }
                 
                 const errorHTML = `
                     <div class="error-container">
                         <div class="error-icon">
                             <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem; color: #dc3545;"></i>
                         </div>
                         <h4 class="text-lg font-semibold text-center mb-4" style="color: #dc3545;">Error en la Reserva</h4>
                         <p class="error-message text-center mb-4">${errorMessage}</p>
                         <div class="text-center">
                             <button class="boton-fecha" onclick="resetFormInModal()">Intentar de Nuevo</button>
                             <button class="boton-fecha" onclick="hideForm()" style="margin-left: 10px; background-color: #6c757d;">Cerrar</button>
                         </div>
                     </div>
                 `;
                 
                 form.innerHTML = errorHTML;
                 console.log('Error mostrado en modal exitosamente');
                 
             } catch (error) {
                 console.error('ERROR en showErrorInModal:', error);
             }
         }
         
         // Función para resetear el formulario en el modal
         function resetFormInModal() {
             const form = document.getElementById('reservaForm');
             
             const formHTML = `
                 <label>Nombre</label>
                 <input type="text" name="firstName" required class="input-field" />

                 <label>Apellido</label>
                 <input type="text" name="lastName" required class="input-field" />

                 <label>DNI</label>
                 <input type="text" name="dni" required class="input-field" />

                 <label>Email</label>
                 <input type="email" name="email" required class="input-field" />

                 <label>Teléfono</label>
                 <input type="tel" name="phone" required class="input-field" />

                 <div class="d-flex justify-content-between pt-3">
                     <button type="submit" class="boton-fecha" id="submitBtn">Reservar Turno</button>
                     <button type="button" class="boton-fecha" onclick="hideForm()">Cancelar</button>
                 </div>
             `;
             
             form.innerHTML = formHTML;
             
             // Reasignar el event listener
             form.addEventListener('submit', handleSubmit);
         }
         
         // Función para mostrar información del turno dentro del modal
         function showTurnInfoInModal(turnInfo) {
             try {
                 // Obtener elementos del DOM
                 const form = document.getElementById('reservaForm');
                 const message = document.getElementById('message');
                 
                 if (!form) {
                     console.error('ERROR: No se encontró el formulario');
                     return;
                 }
                 
                 // Obtener el código del turno desde turnInfo
                 const turnCode = turnInfo.codigo;
                 
                 // Crear el HTML para mostrar la información del turno con actualizaciones en tiempo real
                 const turnInfoHTML = `
                     <div class="turn-info-container">
                         <h4 class="text-lg font-semibold text-center mb-4" style="color: #863DFF;">✅ Turno Reservado Exitosamente</h4>
                         <p class="text-center mb-4" style="color: #28a745; font-weight: 600;">¡Tu turno ha sido generado en el sistema!</p>
                         <div class="turn-info-grid">
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Código del Turno:</div>
                                 <div class="turn-info-value" id="turnCodeDisplay">${turnCode || 'No disponible'}</div>
                             </div>
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Número de Turno:</div>
                                 <div class="turn-info-value">${turnInfo.turno}</div>
                             </div>
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Estado del Turno:</div>
                                 <div class="turn-info-value" id="turnStatus">Consultando...</div>
                             </div>
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Tiempo de Espera Actual:</div>
                                 <div class="turn-info-value" id="currentWaitingTime">Consultando...</div>
                             </div>
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Tiempo Promedio de Espera:</div>
                                 <div class="turn-info-value">${turnInfo.tiempoEspera} min</div>
                             </div>
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Especialidad:</div>
                                 <div class="turn-info-value">${turnInfo.especialidad}</div>
                             </div>
                             <div class="turn-info-item">
                                 <div class="turn-info-label">Sala de Espera:</div>
                                 <div class="turn-info-value">${turnInfo.salaEspera}</div>
                             </div>
                         </div>
                         <div class="text-center mt-4">
                             <button class="boton-fecha" onclick="hideForm()">Cerrar</button>
                         </div>
                     </div>
                 `;
                 
                 // Ocultar el formulario y mostrar la información del turno
                 form.style.display = 'none';
                 message.innerHTML = turnInfoHTML;
                 message.classList.remove('hidden');
                 
                 // Iniciar el polling del estado del turno
                 if (turnCode && turnCode !== 'N/A' && turnCode !== 'No disponible') {
                     startTurnStatusPolling(turnCode);
                 }
                 
             } catch (error) {
                 console.error('Error en showTurnInfoInModal:', error);
                 
                 // Mostrar mensaje de error genérico
                 const form = document.getElementById('reservaForm');
                 const message = document.getElementById('message');
                 
                 if (form && message) {
                     form.style.display = 'none';
                     message.innerHTML = `
                         <div class="error-container">
                             <h4 class="text-lg font-semibold text-center mb-4" style="color: #dc3545;">❌ Error al mostrar información del turno</h4>
                             <p class="text-center mb-4">Hubo un problema al procesar la información del turno.</p>
                             <div class="text-center">
                                 <button class="boton-fecha" onclick="showForm()">Volver</button>
                             </div>
                         </div>
                     `;
                     message.classList.remove('hidden');
                 }
             }
         }
         

         

         
         // Función para reservar turno real invocando el API
         async function reservarTurnoReal() {
             console.log('=== RESERVANDO TURNO REAL ===');
             
             // Obtener los datos del formulario
             const form = document.getElementById('reservaForm');
             const firstName = form.querySelector('input[name="firstName"]').value;
             const lastName = form.querySelector('input[name="lastName"]').value;
             const dni = form.querySelector('input[name="dni"]').value;
             const email = form.querySelector('input[name="email"]').value;
             const phone = form.querySelector('input[name="phone"]').value;
             
             // Validar que todos los campos estén completos
             if (!firstName || !lastName || !dni || !email || !phone) {
                 alert('Por favor, completa todos los campos del formulario');
                 return;
             }
             
             console.log('Datos del formulario:', { firstName, lastName, dni, email, phone });
             
             // Cambiar el botón a estado de carga
             const submitBtn = document.getElementById('submitBtn');
             const originalText = submitBtn.textContent;
             submitBtn.textContent = 'Reservando...';
             submitBtn.disabled = true;
             
             try {
                 console.log('Invocando API para reservar turno...');
                 const response = await fetch('https://filavirtual2.debmedia.com/api/v1/queue/14003/branch/10387/enqueue', {
                     method: 'POST',
                     headers: {
                         'x-api-token': 'bLb0B67zB43NwgaM2EaDrQk1PTPcbl5JB2UFV6S3',
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         firstName,
                         lastName,
                         dni,
                         email,
                         phone
                     })
                 });
                 
                 console.log('Respuesta del API:', response.status, response.ok);
                 
                 if (response.ok) {
                     const responseData = await response.json();
                     console.log('Datos del API recibidos:', responseData);
                     
                     // Log detallado de la estructura de la respuesta
                     console.log('Estructura de la respuesta:', {
                         hasJsonDetails: !!responseData.jsonDetails,
                         jsonDetailsKeys: responseData.jsonDetails ? Object.keys(responseData.jsonDetails) : 'No existe',
                         actualTurn: responseData.jsonDetails?.actualTurn,
                         turn: responseData.jsonDetails?.turn,
                         averageWaitingTime: responseData.jsonDetails?.averageWaitingTime,
                         serviceTime: responseData.jsonDetails?.serviceTime,
                         queueName: responseData.jsonDetails?.queue?.name,
                         waitingRoomName: responseData.jsonDetails?.waitingRoom?.name,
                         code: responseData.code
                     });
                     
                     // Log específico para el turno
                     console.log('🔍 VALORES DEL TURNO:', {
                         'responseData.jsonDetails.turn': responseData.jsonDetails?.turn,
                         'responseData.jsonDetails.actualTurn': responseData.jsonDetails?.actualTurn,
                         'responseData.code': responseData.code
                     });
                     
                     // Extraer información del turno con fallbacks mejorados
                     let turnInfo = {
                         turno: 'N/A',
                         tiempoEspera: 'N/A',
                         especialidad: 'N/A',
                         salaEspera: 'N/A',
                         codigo: responseData.code || 'N/A' // Agregar el código del turno
                     };
                     
                     // Intentar extraer datos de diferentes estructuras posibles
                     if (responseData.jsonDetails) {
                         turnInfo.turno = responseData.jsonDetails.turn || responseData.jsonDetails.actualTurn || 'N/A';
                         turnInfo.tiempoEspera = responseData.jsonDetails.serviceTime || responseData.jsonDetails.averageWaitingTime || 'N/A';
                         turnInfo.especialidad = responseData.jsonDetails.queue?.name || 'N/A';
                         turnInfo.salaEspera = responseData.jsonDetails.waitingRoom?.name || 'N/A';
                     } else if (responseData.code) {
                         // Si no hay jsonDetails, usar datos del nivel principal
                         turnInfo.turno = responseData.code || 'N/A';
                         turnInfo.tiempoEspera = responseData.jsonDetails?.serviceTime || 'N/A';
                         turnInfo.especialidad = 'Atención General';
                         turnInfo.salaEspera = 'Sala Principal';
                     }
                     
                     // Redondear el tiempo de espera para mostrar solo la parte entera
                     if (turnInfo.tiempoEspera !== 'N/A' && !isNaN(turnInfo.tiempoEspera)) {
                         const tiempoOriginal = turnInfo.tiempoEspera;
                         turnInfo.tiempoEspera = Math.floor(parseFloat(turnInfo.tiempoEspera));
                         console.log(`Tiempo de espera redondeado: ${tiempoOriginal} → ${turnInfo.tiempoEspera}`);
                     }
                     
                     console.log('Información del turno extraída:', turnInfo);
                     
                     // Log específico para verificar el valor del turno
                     console.log('🎯 VALOR FINAL DEL TURNO:', {
                         'turnInfo.turno': turnInfo.turno,
                         'tipo': typeof turnInfo.turno,
                         'longitud': turnInfo.turno ? turnInfo.turno.length : 'N/A'
                     });
                     
                     // Guardar el código del turno en localStorage
                     if (responseData.code) {
                         localStorage.setItem('turnCode', responseData.code);
                     }
                     
                     // Mostrar la información del turno en el modal
                     showTurnInfoInModal(turnInfo);
                     
                     console.log('✅ TURNO RESERVADO EXITOSAMENTE:', turnInfo.turno);
                     
                 } else {
                     throw new Error('Error en la respuesta del servidor: ' + response.status);
                 }
                 
             } catch (error) {
                 console.error('Error durante la reserva del turno:', error);
                 
                 // Mostrar error en el modal
                 showErrorInModal('Error al reservar el turno: ' + error.message);
                 
             } finally {
                 // Restaurar el botón
                 submitBtn.textContent = originalText;
                 submitBtn.disabled = false;
                 console.log('=== FIN DE RESERVA DE TURNO ===');
             }
         }
         
         // Hacer las funciones disponibles globalmente
         window.reservarTurnoReal = reservarTurnoReal;
         window.startTurnStatusPolling = startTurnStatusPolling;
         window.stopTurnStatusPolling = stopTurnStatusPolling;
         
         // Función para consultar recurrentemente el estado del turno
         function startTurnStatusPolling(turnCode) {
             // Verificar que se recibió el código del turno
             if (!turnCode || turnCode === 'N/A' || turnCode === 'No disponible') {
                 console.error('No se recibió código de turno válido para consultar:', turnCode);
                 return;
             }
             
             // Inicializar contador de consultas
             let callCount = 0;
             
             // Función para realizar la consulta a la API
             async function consultarEstadoTurno() {
                 try {
                     // Incrementar contador de consultas (solo para logging interno)
                     callCount++;
                     
                     // Consultar la API del estado del turno
                     const response = await fetch(`https://filavirtual2.debmedia.com/api/v1/turn/code/${turnCode}`, {
                         method: 'GET',
                         headers: {
                             'x-api-token': 'iyAUHKKJ2NTsxf4sAH1OWm3fljRsThvxF0kbCGWe',
                             'Content-Type': 'text/plain'
                         }
                     });
                     
                     if (response.ok) {
                         const data = await response.json();
                         
                         // Actualizar estado del turno
                         const statusElement = document.getElementById('turnStatus');
                         if (statusElement) {
                             let statusText = data.status || 'Desconocido';
                             
                             // Traducir estados específicos
                             if (data.status === 'ANNOUNCED') {
                                 statusText = 'Lo estamos llamando';
                             } else if (data.status === 'WAITING_TO_BE_CALLED') {
                                 statusText = 'En breve lo llamaremos';
                             } else if (data.status === 'FINALIZED') {
                                 statusText = 'Atención finalizada';
                             }
                             
                             statusElement.textContent = statusText;
                             statusElement.style.color = getStatusColor(data.status);
                         }
                         
                         // Actualizar tiempo de espera actual
                         const waitingTimeElement = document.getElementById('currentWaitingTime');
                         if (waitingTimeElement) {
                             waitingTimeElement.textContent = data.averageWaitingTime ? `${data.averageWaitingTime} min` : 'N/A';
                         }
                         
                     } else {
                         // Mostrar error en los elementos
                         const statusElement = document.getElementById('turnStatus');
                         const waitingTimeElement = document.getElementById('currentWaitingTime');
                         
                         if (statusElement) {
                             statusElement.textContent = 'Error al consultar';
                             statusElement.style.color = '#dc3545';
                         }
                         
                         if (waitingTimeElement) {
                             waitingTimeElement.textContent = 'Error al consultar';
                             waitingTimeElement.style.color = '#dc3545';
                         }
                     }
                     
                 } catch (error) {
                     console.error(`Error en consulta de estado del turno (consulta #${callCount}):`, error);
                     
                     // Mostrar error en los elementos
                     const statusElement = document.getElementById('turnStatus');
                     const waitingTimeElement = document.getElementById('currentWaitingTime');
                     
                     if (statusElement) {
                         statusElement.textContent = 'Error de conexión';
                         statusElement.style.color = '#dc3545';
                     }
                     
                     if (waitingTimeElement) {
                         waitingTimeElement.textContent = 'Error de conexión';
                         waitingTimeElement.style.color = '#dc3545';
                     }
                 }
             }
             
             // Función para obtener color según el estado
             function getStatusColor(status) {
                 const statusLower = status.toLowerCase();
                 if (statusLower.includes('espera') || statusLower.includes('waiting')) return '#ffc107';
                 if (statusLower.includes('atendiendo') || statusLower.includes('attending')) return '#28a745';
                 if (statusLower.includes('completado') || statusLower.includes('completed')) return '#17a2b8';
                 if (statusLower.includes('cancelado') || statusLower.includes('cancelled')) return '#dc3545';
                 return '#6c757d';
             }
             
             // Realizar la primera consulta inmediatamente
             consultarEstadoTurno();
             
             // Configurar consultas recurrentes cada 5 segundos
             const pollingInterval = setInterval(consultarEstadoTurno, 5000);
             
             // Guardar el intervalo para poder detenerlo si es necesario
             window.turnStatusPollingInterval = pollingInterval;
         }
         
         // Función para detener las consultas recurrentes (opcional)
         function stopTurnStatusPolling() {
             if (window.turnStatusPollingInterval) {
                 clearInterval(window.turnStatusPollingInterval);
                 window.turnStatusPollingInterval = null;
             }
         }
         
         // Función para mostrar información del turno (modal flotante)
         function showTurnInfo(turnInfo) {
             const turnInfoDiv = document.createElement('div');
             turnInfoDiv.className = 'fixed top-4 left-4 bg-white px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 max-w-md turn-info-display';
             turnInfoDiv.innerHTML = `
                 <div class="flex items-center justify-between mb-3">
                     <h4 class="text-lg font-semibold">Información del Turno</h4>
                     <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
                 </div>
                 <div class="space-y-3">
                     <div class="info-row">
                         <span class="info-label">Número de Turno:</span>
                         <span class="info-value">${turnInfo.turno}</span>
                     </div>
                     <div class="info-row">
                         <span class="info-label">Tiempo Promedio de Espera:</span>
                         <span class="info-value">${turnInfo.tiempoEspera} min</span>
                     </div>
                     <div class="info-row">
                         <span class="info-label">Especialidad:</span>
                         <span class="info-value">${turnInfo.especialidad}</span>
                     </div>
                     <div class="info-row">
                         <span class="info-label">Sala de Espera:</span>
                         <span class="info-value">${turnInfo.salaEspera}</span>
                     </div>
                 </div>
             `;
             document.body.appendChild(turnInfoDiv);
         }
         
         // Función para abrir popup de Medicina al Viajero
         function openViajeroPopup() {
             const url = 'https://filavirtual2.debmedia.com/app/buscar/ventasalud?queueName=Atención con especialista - Videollamada&branchId=10387';
             const popup = window.open(url, 'ViajeroPopup', 'width=800,height=600,scrollbars=yes,resizable=yes', 600, 400);
             
             // Enfocar el popup si se abrió correctamente
             if (popup) {
                 popup.focus();
             } else {
                 // Si el popup fue bloqueado, mostrar mensaje
                 showErrorMessage('El popup fue bloqueado. Por favor, permite popups para este sitio.');
             }
         }

        // Event listeners
        document.getElementById('reservaForm').addEventListener('submit', handleSubmit);

        // Cerrar modal al hacer clic fuera de él (solo cuando esté habilitado)
        document.getElementById('formModal').addEventListener('click', function(e) {
            console.log('Modal clickeado, target:', e.target, 'this:', this);
            console.log('pointerEvents del modal:', this.style.pointerEvents);
            
            if (e.target === this && this.style.pointerEvents !== 'none') {
                console.log('Cerrando modal por clic fuera');
                hideForm();
            } else {
                console.log('Modal no se puede cerrar - pointerEvents bloqueado');
            }
        });

window.fechaSeleccionadaGlobal = null;
window.duracionSeleccionadaGlobal = null;

    flatpickr("#fecha", {
      dateFormat: "Y-m-d",
      minDate: "today", // evitar fechas anteriores
      onChange: function(selectedDates, dateStr) {
        if (selectedDates.length > 0) {
          consultarDisponibilidad(dateStr);
        }
      }
    });

    async function consultarDisponibilidad(strDate) {
      const resultados = document.getElementById("resultados");
      resultados.innerHTML = "Consultando disponibilidad...";

      const baseUrl = "https://citas2.debmedia.com/api/v2/schedules";
      const strDateEncoded = encodeURIComponent(strDate);
              const branchId = document.getElementById("sucuComboValue").value;
              const scheduleId = document.getElementById("salaComboValue").value;
      const url = `${baseUrl}/${scheduleId}/branch/${branchId}/availability?strDate=${strDateEncoded}`;

      try {
        const response = await fetch(url, {
          method: "GET",
          headers: {
            "x-api-token": "GoEH5j9TMjWhWojrOLKT8qYEXbPlMH7atIo8Nsxh"
          }
        });

        if (!response.ok) throw new Error("Error en la solicitud: " + response.status);
        const data = await response.json();

        const dias = Array.isArray(data) ? data : (Array.isArray(data.slots) ? data.slots : []);

        if (dias.length === 0) {
          resultados.innerHTML = "No hay horarios disponibles para esta fecha.";
          return;
        }

        let html = "<div><h3 class='titulo'>Horarios disponibles:</h3></div>";
        html+="<div>"
        dias.forEach(dia => {
          const horaMinuto = dia.zonedStartDate.substring(11, 16);
          html += `&nbsp<button class="boton-fecha" onclick="mostrarFormulario('${dia.zonedStartDate}', ${dia.defaultDuration})">${horaMinuto}</button>&nbsp`;
        });
          html+="</div>"
        resultados.innerHTML = html;

      } catch (err) {
        console.error("Error atrapado:", err);
        resultados.innerHTML = `<strong>Error:</strong> ${err.message}`;
      }
    }

    function mostrarFormulario(fecha, duracion) {
      window.fechaSeleccionadaGlobal = fecha;
      window.duracionSeleccionadaGlobal = duracion;

      const resultados = document.getElementById("formularioDatos");
	document.getElementById("formularioDatos").style.display = "block";

	//document.getElementById("bloqueFecha").style.display = "none";
	//document.getElementById("formularioInicial").style.display = "none";

	document.getElementById("resultados").style.display = "none";


      let html = `
        <h3 class='titulo'>Completa tus datos</h3>
        <form id="formularioTurno" onsubmit="return enviarFormulario(event)">
          <label>Nombre:</label>
          <input type="text" id="nombre" required>
          <label>Apellido:</label>
          <input type="text" id="apellido" required>
          <label>DNI:</label>
          <input type="text" id="dni" required>
          <label>Email:</label>
          <input type="email" id="email" required>
          <label>Motivo:</label>
          <select id="motivo" required>
            <option value="">Seleccionar...</option>
            <option value="Consulta general">Consulta general</option>
            <option value="Revisión">Revisión</option>
            <option value="Control de tratamiento">Control de tratamiento</option>
          </select>
          <br><br>
          <button type="submit" class="boton-fecha">Confirmar Turno</button>
        </form>
      `;
      resultados.innerHTML = html;
    }
window.mostrarFormulario = mostrarFormulario;
    function enviarFormulario(event) {
      event.preventDefault();
      const datos = {
        nombre: document.getElementById("nombre").value,
        apellido: document.getElementById("apellido").value,
        dni: parseInt(document.getElementById("dni").value),
        email: document.getElementById("email").value,
        motivo: document.getElementById("motivo").value
      };

      crearCita(window.fechaSeleccionadaGlobal, window.duracionSeleccionadaGlobal, datos);
    }

    async function crearCita(fechaInicio, duracionMinutos, datosCliente) {
      const resultados = document.getElementById("final");

      const startDate = new Date(fechaInicio);
      const endDate = new Date(startDate.getTime() + duracionMinutos * 60000);

      const pad = n => n.toString().padStart(2, '0');
        resultados.innerHTML = `1`;
      function formatISO(date) {
        const yyyy = date.getFullYear();
        const MM = pad(date.getMonth() + 1);
        const dd = pad(date.getDate());
        const hh = pad(date.getHours());
        const mm = pad(date.getMinutes());
        return `${yyyy}-${MM}-${dd}T${hh}:${mm}:00-0300`;
      }

      const startAt = formatISO(startDate);
      const endAt = formatISO(endDate);

      const data = {
        branch: { id:  document.getElementById("sucuComboValue").value },
        schedule: { id:  document.getElementById("salaComboValue").value },
        startAt: startAt,
        endAt: endAt,
        customer: {
          firstName: datosCliente.nombre,
          lastName: datosCliente.apellido,
          dni: datosCliente.dni
         // email: datosCliente.email
        },
        reason: datosCliente.motivo
      };
      try {
        const response = await fetch("https://citas2.debmedia.com/api/v2/appointments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-token": "GoEH5j9TMjWhWojrOLKT8qYEXbPlMH7atIo8Nsxh"
          },
          body: JSON.stringify(data)
        });


        const resultado = await response.json();

        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${resultado.message || JSON.stringify(resultado)}`);
        }



document.getElementById("formularioDatos").style.display = "none";
        resultados.innerHTML = `<strong>✅ La reserva fue creada correctamente. ID: ${resultado.id}</strong>`;

      } catch (error) {
        console.error("Error:", error);
        resultados.innerHTML = `<strong>❌ Error al generar la cita:</strong> ${error.message}`;
      }
    }


async function cargarCombosDesdeAPI() {
  const salaCombo = document.getElementById("salaCombo");
  const sucuCombo = document.getElementById("sucuCombo");

  // Configurar flatpickr
  flatpickr("#fecha", {
    dateFormat: "Y-m-d",
    minDate: "today",
    onChange: function(selectedDates, dateStr) {
      if (selectedDates.length > 0) {
        consultarDisponibilidad(dateStr);
      }
    }
  });

  // Cargar sucursales desde la API
  const url = `https://citas2.debmedia.com/api/v2/reducedSchedules`;

  try {
    const response = await fetch(url, {
      method: "GET",
      headers: {
        "x-api-token": "GoEH5j9TMjWhWojrOLKT8qYEXbPlMH7atIo8Nsxh"
      }
    });

    if (!response.ok) throw new Error("No se pudo cargar la lista de sucursales");
    const data = await response.json();

    // Limpiar y preparar el contenedor de sucursales
    sucuCombo.innerHTML = '';
    
    const addedBranchIds = new Set();
    
    data.forEach(sala => {
      if (Array.isArray(sala.branches)) {
        sala.branches.forEach(branch => {
          if (!addedBranchIds.has(branch.id)) {
            // Crear card de sucursal
            const sucursalCard = document.createElement('div');
            sucursalCard.className = 'sucursal-card';
            sucursalCard.dataset.value = branch.id;
            sucursalCard.innerHTML = `
              <i class="bi bi-building sucursal-icon"></i>
              <div class="sucursal-info">
                <div class="sucursal-name">${branch.name}</div>
                <div class="sucursal-status">Disponible</div>
              </div>
            `;
            
            // Agregar evento de click
            sucursalCard.addEventListener('click', function() {
              // Remover selección previa
              document.querySelectorAll('.sucursal-card').forEach(card => {
                card.classList.remove('selected');
              });
              
              // Seleccionar esta card
              this.classList.add('selected');
              
              // Actualizar el valor oculto
              document.getElementById('sucuComboValue').value = branch.id;
              
              // Cargar salas basadas en especialidad y sucursal seleccionadas
              cargarSalasPorEspecialidadYSucursal();
            });
            
            sucuCombo.appendChild(sucursalCard);
            addedBranchIds.add(branch.id);
          }
        });
      }
    });
    
    // Agregar eventos de click para las especialidades
    document.querySelectorAll('.especialidad-card').forEach(card => {
      card.addEventListener('click', function() {
        // Remover selección previa
        document.querySelectorAll('.especialidad-card').forEach(c => {
          c.classList.remove('selected');
        });
        
        // Seleccionar esta card
        this.classList.add('selected');
        
        // Actualizar el valor oculto
        document.getElementById('especialidadComboValue').value = this.dataset.value;
        
        // Mostrar el selector de sucursales
        document.querySelector('.sucursal-selector').style.display = 'block';
        
        // Cargar salas basadas en especialidad y sucursal seleccionadas
        cargarSalasPorEspecialidadYSucursal();
      });
    });

    document.getElementById('popupModal').style.display='block';

  } catch (err) {
    console.error("Error al cargar sucursales:", err);
    sucuCombo.innerHTML = `<div class="error-card">
      <i class="bi bi-exclamation-triangle"></i>
      <span>Error cargando sucursales</span>
    </div>`;
  }
}

// Nueva función para cargar salas basadas en especialidad y sucursal
async function cargarSalasPorEspecialidadYSucursal() {
  const salaCombo = document.getElementById("salaCombo");
  const especialidadSeleccionada = document.getElementById("especialidadComboValue").value;
  const sucursalSeleccionada = document.getElementById("sucuComboValue").value;

  // Validar que ambos estén seleccionados
  if (!especialidadSeleccionada || !sucursalSeleccionada) {
    salaCombo.innerHTML = `<div class="loading-card">
      <i class="bi bi-arrow-clockwise spin"></i>
      <span>Selecciona especialidad y sucursal para ver las salas disponibles</span>
    </div>`;
    return;
  }

  // Usar directamente el data-value de la especialidad seleccionada
  const especialidadValue = especialidadSeleccionada;
  
  // Mostrar loading
  salaCombo.innerHTML = `<div class="loading-card">
    <i class="bi bi-arrow-clockwise spin"></i>
    <span>Cargando salas para ${especialidadValue}...</span>
  </div>`;

  try {
    // Construir URL con parámetros usando directamente el data-value
    const url = `https://citas2.debmedia.com/api/v2/schedules?tags.name=${encodeURIComponent(especialidadValue)}`;
    
    const response = await fetch(url, {
      method: "GET",
      headers: {
        "x-api-token": "GoEH5j9TMjWhWojrOLKT8qYEXbPlMH7atIo8Nsxh"
      }
    });

    if (!response.ok) throw new Error("No se pudo cargar la lista de salas");
    const data = await response.json();

    // Limpiar contenedor de salas
    salaCombo.innerHTML = '';
    
    // Filtrar salas que pertenezcan a la sucursal seleccionada
    const salasFiltradas = data.filter(sala => {
      return Array.isArray(sala.branches) && 
             sala.branches.some(branch => branch.id === parseInt(sucursalSeleccionada));
    });

    if (salasFiltradas.length === 0) {
      salaCombo.innerHTML = `<div class="error-card">
        <i class="bi bi-exclamation-triangle"></i>
        <span>No hay salas disponibles para ${especialidadValue} en esta sucursal</span>
      </div>`;
      return;
    }

    // Crear cards de salas
    salasFiltradas.forEach(sala => {
      const salaCard = document.createElement('div');
      salaCard.className = 'sala-card';
      salaCard.dataset.value = sala.id;
      salaCard.innerHTML = `
        <i class="bi bi-door-open sala-icon"></i>
        <div class="sala-info">
          <div class="sala-name">${sala.name}</div>
          <div class="sala-status">Disponible</div>
        </div>
      `;
      
      // Agregar evento de click para sala
      salaCard.addEventListener('click', function() {
        // Remover selección previa
        document.querySelectorAll('.sala-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Seleccionar esta card
        this.classList.add('selected');
        
        // Actualizar el valor oculto
        document.getElementById('salaComboValue').value = sala.id;
        
        // Mostrar bloque de fecha cuando se selecciona una sala
        document.getElementById("bloqueFecha").style.display = "block";
      });
      
      salaCombo.appendChild(salaCard);
    });

  } catch (err) {
    console.error("Error al cargar salas:", err);
    salaCombo.innerHTML = `<div class="error-card">
      <i class="bi bi-exclamation-triangle"></i>
      <span>Error cargando salas: ${err.message}</span>
    </div>`;
  }
}

</script>

</html>
